I"û<h2 id="Ã¶zet">Ã–zet</h2>

<p>YanlÄ±ÅŸ Servis Yolu YapÄ±landÄ±rmasÄ±, (Unquoted Services Path) Windows iÅŸletim sistemlerinde hak yÃ¼kseltmek iÃ§in kullanÄ±lan ve oldukÃ§a fazla karÅŸÄ±laÅŸÄ±lan bir yÃ¶ntemdir. Zafiyetin temelinde Windowsâ€™un, servisin Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bulmak iÃ§in kullandÄ±ÄŸÄ± yÃ¶ntem vardÄ±r. Ä°stismar edilerek yerel sistemde yetki yÃ¼kseltilebilir.</p>

<h2 id="detaylar">Detaylar</h2>

<p>Windows iÅŸletim sistemlerinde bir servis Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, iÅŸletim sistemi servisi baÅŸlatmak iÃ§in ilgili Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyayÄ± bulmasÄ± gerekir. Ã–rneÄŸin Fax servisinin baÅŸlamasÄ± iÃ§in iÅŸletim sisteminin <strong>â€œC:\Windows\system32\â€</strong> yolundaki <strong>â€œfxssvc.exeâ€</strong> yÃ¼rÃ¼tÃ¼lebilir dosyayÄ± bilmesi gerekir. Dosya yolu â€œâ€ iÃ§ine eklenmiÅŸ ise iÅŸletim sistemi bu dosyanÄ±n tam olarak nerede olacaÄŸÄ±nÄ± bilecektir. EÄŸer â€œâ€ iÃ§ine eklenmemiÅŸ direkt</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\system32\fxssvc.exe
</code></pre></div></div>
<p>ÅŸeklinde ilgili Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyayÄ± bulacaktÄ±r.</p>

<p align="center">
	<img src="/images/unquoted_ss/1.png" alt="" />
</p>

<p>Ã‡alÄ±ÅŸtÄ±rÄ±lacak dosya yolu iÃ§erisinde boÅŸluk var ve â€œâ€ iÃ§erisine alÄ±nmamÄ±ÅŸ ise iÅŸletim sistemi dosyanÄ±n tam olarak nerede olduÄŸunu bilemeyecek ve aramayÄ± sÄ±rasÄ± ile;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Program.exe
C:\Program Files.exe
C:\Program Files (x86).exe
C:\Program Files (x86)\Lavasoft.exe
C:\Program Files (x86)\Lavasoft\Web.exe
C:\Program Files (x86)\Lavasoft\Web Companion.exe
C:\Program Files (x86)\Lavasoft\Web Companion\Application.exe
C:\Program Files (x86)\Lavasoft\Web Companion\Application\Lavasoft.WCAssistant.WinService.exe
</code></pre></div></div>

<p>ÅŸeklinde yaparak ilgili dosyayÄ± arayacaktÄ±r. Ã–zetle iÅŸletim sistemi bu dosyayÄ± buluncaya kadar ilgili yoldaki her dosyanÄ±n sonuna .exe ekleyerek tek tek Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyayÄ± arayacaktÄ±r.</p>

<h3 id="zafiyetin-kaynaÄŸÄ±">Zafiyetin KaynaÄŸÄ±</h3>

<p>Ä°ÅŸletim sisteminin bu ÅŸekilde davranmasÄ±ndaki sebep <strong>CreateProcess</strong> Ã§aÄŸrÄ±sÄ±ndaki <strong>lpApplicationName</strong> parametresidir. lpApplicationName parametresi Ã§alÄ±ÅŸtÄ±rÄ±lacak modÃ¼lÃ¼n tam yolu ve dosya adÄ± olmalÄ±dÄ±r. Aksi taktirde iÅŸletim sistemi Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyayÄ± aramaya baÅŸlayacaktÄ±r.</p>

<blockquote>
  <p>The lpApplicationName parameter can be NULL. In that case, the module name must be the first white spaceâ€“delimited token in the lpCommandLine string. If you are using a long file name that contains a space, use quoted strings to indicate where the file name ends and the arguments begin; otherwise, the file name is ambiguous. For example, consider the string â€œc:\program files\sub dir\program nameâ€. This string can be interpreted in a number of ways. The system tries to interpret the possibilities in the following order:
c:\program.exe c:\program files\sub.exe c:\program files\sub dir\program.exe c:\program files\sub dir\program name.exe If the executable module is a 16-bit application, lpApplicationName should be NULL, and the string pointed to by lpCommandLine should specify the executable module as well as its arguments.</p>
</blockquote>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa#parameters">Kaynak</a></p>

<p align="center">
	<img src="/images/unquoted_ss/2.png" alt="" />
</p>

<h3 id="iÌ‡stismar-edilmesi">Ä°stismar Edilmesi</h3>

<p>Bu durumda zararlÄ± yazÄ±lÄ±m hazÄ±rlanÄ±p kÃ¶k dizinden baÅŸlayacak ÅŸekilde yazma izni olan herhangi bir yola yerleÅŸtirilirse servis tekrar baÅŸlatÄ±ldÄ±ÄŸÄ±nda zararlÄ± yazÄ±lÄ±m Ã§alÄ±ÅŸacaktÄ±r. Ã–rneÄŸin â€œC:\â€ dizinine Program.exe isminde yerleÅŸtirilen herhangi bir yÃ¼rÃ¼tÃ¼lebilir dosya Ã§alÄ±ÅŸacaktÄ±r.</p>

<p>Program.exe adÄ±nda ki zararlÄ± yazÄ±lÄ±mÄ±n oluÅŸturulmasÄ±na dair ekran gÃ¶rÃ¼ntÃ¼sÃ¼ verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/unquoted_ss/3.png" alt="" />
</p>

<p>ZararlÄ± yazÄ±lÄ±mÄ±n sisteme yÃ¼klendiÄŸine ve zafiyeti barÄ±ndÄ±ran yollardan birisine koyulduÄŸuna dair ekran gÃ¶rÃ¼ntÃ¼sÃ¼ verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/unquoted_ss/4.png" alt="" />
</p>

<p>Ã‡alÄ±ÅŸtÄ±rÄ±lan zararlÄ±, servisin Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ± haklar ile aynÄ± haklarda Ã§alÄ±ÅŸacaktÄ±r.</p>

<p align="center">
	<img src="/images/unquoted_ss/5.png" alt="" />
</p>

<p>YapÄ±landÄ±rma eksikliÄŸi olan servisin Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra zararlÄ± yazÄ±lÄ±mÄ± tetiklemesi ile NT AUTHORITY\SYSTEM haklarÄ±nda elde edilen meterpreter oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼ verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/unquoted_ss/6.png" alt="" />
</p>

<h3 id="not">NOT</h3>

<p>Windows iÅŸletim sistemi servisin dÃ¼zgÃ¼n baÅŸlatÄ±lÄ±p baÅŸlatÄ±lmadÄ±ÄŸÄ±nÄ± kontrol eder. EÄŸer servis 3 dakika iÃ§erisinde dÃ¼zgÃ¼n baÅŸlatÄ±lmaz ise aÅŸaÄŸÄ±da ki ekran gÃ¶rÃ¼ntÃ¼sÃ¼nde verilen bilgilendirmeyi yapar ve Ã¶ncesinde baÅŸlattÄ±ÄŸÄ± bÃ¼tÃ¼n sÃ¼reÃ§leri Ã¶ldÃ¼rÃ¼r. ManipÃ¼le edilen servis dÃ¼zgÃ¼n baÅŸlatÄ±lmadÄ±ÄŸÄ± iÃ§in bu yapÄ±landÄ±rma eksikliÄŸinde aynÄ± problemle karÅŸÄ±laÅŸabilirsiniz. KÄ±sa sÃ¼re iÃ§erisinde baÅŸka bir sÃ¼rece migrate olmanÄ±z gerekmektedir.</p>

<p align="center">
	<img src="/images/unquoted_ss/7.png" alt="" />
</p>

<h2 id="servislerin-bulunmasÄ±">Servislerin BulunmasÄ±</h2>

<h3 id="yol--1">Yol -1:</h3>

<p>Manuel olarak komut satÄ±rÄ±nda</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic service get name,displayname,pathname,startmode |findstr /i â€œautoâ€ |findstr /i /v â€œc:\windows\â€ |findstr /i /v â€œâ€â€
</code></pre></div></div>

<p>komutu yeterli olacaktÄ±r.</p>

<p align="center">
	<img src="/images/unquoted_ss/8.png" alt="" />
</p>

<h3 id="yol--2">Yol -2:</h3>

<p><a href="https://github.com/hlldz/dazzleUP">DazzleUP</a> kullanarak yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸ servis yollarÄ±nÄ± tespit edebilirsiniz.</p>

<p align="center">
	<img src="/images/unquoted_ss/9.png" alt="" />
</p>

<h3 id="yol--3">Yol -3:</h3>

<p>PowerUp.ps1 kullanarak <strong>Get-ServiceUnquoted</strong> fonksiyonu ile bulunabilir.</p>

<p align="center">
	<img src="/images/unquoted_ss/10.png" alt="" />
</p>

<h2 id="Ã§Ã¶zÃ¼m">Ã‡Ã¶zÃ¼m:</h2>

<p>KayÄ±t defterindeki <strong>HKLM\SYSTEM\CurrentControlSet\services</strong> bÃ¶lÃ¼mÃ¼ incelenir. Servislerden ImagePath dizesi kontrol edilir. Dikkat edilmesi gereken nokta Ã§ift tÄ±rnak iÃ§inde olmayan ve iÃ§inde boÅŸluk geÃ§en yollardÄ±r.</p>

<p align="center">
	<img src="/images/unquoted_ss/11.png" alt="" />
</p>

<p>ImagePath dizesi dÃ¼zenlenerek yol Ã§ift tÄ±rnak iÃ§ine alÄ±nÄ±r ve ilgili yapÄ±landÄ±rma eksikliÄŸi giderilmiÅŸ olur.</p>

<p align="center">
	<img src="/images/unquoted_ss/12.png" alt="" />
</p>

<h2 id="kaynakÃ§a">KaynakÃ§a:</h2>

<ul>
  <li>https://support.microsoft.com/tr-tr/help/278712/error-message-error-1053-when-using-the-services-snap-in</li>
  <li>https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa#parameters</li>
  <li>https://gallery.technet.microsoft.com/scriptcenter/Windows-Unquoted-Service-190f0341</li>
  <li>https://github.com/hlldz/dazzleUP</li>
</ul>
:ET