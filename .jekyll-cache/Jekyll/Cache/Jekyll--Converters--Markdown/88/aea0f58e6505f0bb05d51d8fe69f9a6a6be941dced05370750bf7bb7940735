I"É#<h2 id="Ã¶zet">Ã–zet</h2>

<p>AlwaysInstallElevated, Windows iÅŸletim sistemlerinde yÃ¼ksek ayrÄ±calÄ±klarla MSI paketlerini Ã§alÄ±ÅŸtÄ±rmaya izin veren bir Ã¶zelliktir. KÃ¶tÃ¼ niyetli kiÅŸiler tarafÄ±ndan istismar edilerek NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ± elde edilebilir.</p>

<h2 id="detaylar">Detaylar</h2>

<p>Windows iÅŸletim sistemi uygulamalarÄ± yÃ¼klemek iÃ§in MSI (Microsoft Windows Installer) paketlerini kullanÄ±r. AlwaysInstallElevated Ã¶zelliÄŸi aktif ise Windows, MSI paketlerini normal kullanÄ±cÄ±lar iÃ§in sistem ayrÄ±calÄ±klarÄ±nda yÃ¼klemesine izin verir. Burada ki amaÃ§ kullanÄ±cÄ±larÄ±n sistem ayrÄ±calÄ±klarÄ± gerektiren bir uygulama yÃ¼klemek istediÄŸinde sistem yÃ¶neticisinin kullanÄ±cÄ±ya geÃ§ici yerel yÃ¶netici eriÅŸimi vermeden kurulum yapabilmesini saÄŸlamaktÄ±r. Ancak kÃ¶tÃ¼ niyetli kiÅŸiler tarafÄ±ndan bu durum istismar edilerek NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±na yÃ¼kselmek iÃ§in kullanÄ±labilir. Ä°stismar edildiÄŸinde sistemde Ã§ok fazla ayrÄ±calÄ±k elde edilebileceÄŸi iÃ§in bu Ã¶zelliÄŸin kullanÄ±lmamasÄ± tavsiye edilmektedir. KÄ±sacasÄ± AlwaysInstallElevated bir zafiyet deÄŸildir, Ã¶zelliÄŸin kÃ¶tÃ¼ye kullanÄ±mÄ± sayesinde hak yÃ¼kseltilebilmesini saÄŸlar.</p>

<p><strong>NOT:</strong> MSI paketlerinin Ã§alÄ±ÅŸmasÄ± iÃ§in yÃ¼ksek ayrÄ±calÄ±klara ihtiyaÃ§larÄ± yoktur.</p>

<blockquote>
  <p>This policy setting directs Windows Installer to use elevated permissions when it installs any program on the system.
If you enable this policy setting, privileges are extended to all programs. These privileges are usually reserved for programs that have been assigned to the user (offered on the desktop), assigned to the computer (installed automatically), or made available in Add or Remove Programs in Control Panel. This profile setting lets users install programs that require access to directories that the user might not have permission to view or change, including directories on highly restricted computers
If you disable or do not configure this policy setting, the system applies the current userâ€™s permissions when it installs programs that a system administrator does not distribute or offer.
Note: This policy setting appears both in the Computer Configuration and User Configuration folders. To make this policy setting effective, you must enable it in both folders.
Caution: Skilled users can take advantage of the permissions this policy setting grants to change their privileges and gain permanent access to restricted files and folders. Note that the User Configuration version of this policy setting is not guaranteed to be secure.</p>
</blockquote>

<p><strong>Kaynak:</strong> Group Policy â€œAlways install with elevated privilegesâ€ Settings</p>

<p>Zafiyetin kaynaÄŸÄ± aÅŸaÄŸÄ±da verilmiÅŸ olan anahtar kÄ±smÄ±na DWORD tipinde â€œAlwaysInstallElevatedâ€œ deÄŸeri 1 olarak ayarlanmÄ±ÅŸ olmasÄ±dÄ±r.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer
HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer
</code></pre></div></div>

<p>2 farklÄ± yol ile aÅŸaÄŸÄ±da gÃ¶sterilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/1.png" alt="" />
</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/2.png" alt="" />
</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/3.png" alt="" />
</p>

<h2 id="iÌ‡stismar-edilmesi">Ä°stismar Edilmesi</h2>

<h3 id="yol--1">Yol -1:</h3>

<p>Senaryo olarak hedef sistemde test adlÄ± dÃ¼ÅŸÃ¼k ayrÄ±calÄ±klardaki kullanÄ±cÄ±nÄ±n Program.msi dosyasÄ±nÄ± indirip kurmasÄ± beklenmektedir.</p>

<p>Ä°lk adÄ±mda msfvenom ile reverse_tcp Ã¼zerinden meterpreter oturumu oluÅŸturacak zararlÄ± yazÄ±lÄ±mÄ±mÄ±zÄ± hazÄ±rlÄ±yoruz. Daha sonra zararlÄ± yazÄ±lÄ±mÄ± NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±nda Ã§alÄ±ÅŸtÄ±racak yÃ¼kseliyici scriptimizi (msi) hazÄ±rlÄ±yoruz. Scripte zararlÄ±nÄ±n hangi dizinde olacaÄŸÄ±nÄ± bildiriyoruz.
ZararlÄ± yazÄ±lÄ±mÄ±n ve yÃ¼kleyici scriptin oluÅŸturulmasÄ±na ait ekran gÃ¶rÃ¼ntÃ¼sÃ¼ aÅŸaÄŸÄ±da verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/4.png" alt="" />
</p>

<p>YÃ¼kleyici scriptin Ã§alÄ±ÅŸtÄ±rÄ±lÄ±p zararlÄ± yazÄ±lÄ±mÄ± tetiklemesine dair ekran gÃ¶rÃ¼ntÃ¼sÃ¼ aÅŸaÄŸÄ±da verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/5.png" alt="" />
</p>

<p>YÃ¼kleyici script Ã§alÄ±ÅŸtÄ±ktan sonra zararlÄ± yazÄ±lÄ±m tetiklendi ve meterpreter oturumu elde edildi. Elde edilen meterpreter oturumu aÅŸaÄŸÄ±da verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/6.png" alt="" />
</p>

<h3 id="yol--2">Yol -2:</h3>

<p>Bir farklÄ± senaryo olarak direkt olarak meterpreter oturumu elde edilerek sisteme eriÅŸilmesi gÃ¶sterilmiÅŸtir.</p>

<p>Ä°lk adÄ±mda msfvenom ile reverse_tcp Ã¼zerinden meterpreter oturumu oluÅŸturacak yÃ¼kleyici scripti hazÄ±rlÄ±yoruz. Script NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±nda Ã§alÄ±ÅŸacaÄŸÄ± iÃ§in meterpreter oturumuda NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±nda olacaktÄ±r. Ä°kinci bir zararlÄ± yazÄ±lÄ±ma ihtiyaÃ§ duyulmayacaktÄ±r.</p>

<p><strong>NOT:</strong> Bu durum incelendiÄŸinde msfvenom ile script Ã¼retilirken payload olarak windows/exec seÃ§ilerek komutta Ã§alÄ±ÅŸtÄ±rabilirsiniz. Ancak bu durum hak yÃ¼kseltme olmadÄ±ÄŸÄ± iÃ§in bu yazÄ±nÄ±n konusu deÄŸildir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/7.png" alt="" />
</p>

<p>ZararlÄ± scriptin Ã§alÄ±ÅŸtÄ±rÄ±larak meterpreter oturumunu aÃ§tÄ±ÄŸÄ±na dair ekran gÃ¶rÃ¼ntÃ¼sÃ¼ aÅŸaÄŸÄ±da verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/8.png" alt="" />
</p>

<p>NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±nda elde edilen meterpreter oturumu aÅŸaÄŸÄ±da gÃ¶sterilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/9.png" alt="" />
</p>

<h3 id="yol--3">Yol -3:</h3>

<p>Son senaryo olarak sisteme dÃ¼ÅŸÃ¼k ayrÄ±calÄ±klarda bulaÅŸmÄ±ÅŸ bir zararlÄ± yazÄ±lÄ±m olsun. ZararlÄ± yazÄ±lÄ±mdan meterpreter oturumu elde edilmiÅŸ olsun. EÄŸer ki ilgili zafiyet varsa sisteme yine bir yÃ¼kleyici script oluÅŸturarak NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±na eriÅŸilebilir.</p>

<p>Sistemde dÃ¼ÅŸÃ¼k ayrÄ±calÄ±klara sahip kullanÄ±cÄ± Ã¼zerinden oluÅŸturulmuÅŸ meterpreter oturumu aÅŸaÄŸÄ±da gÃ¶sterilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/12.png" alt="" />
</p>

<p>Oturum arka plana atÄ±larak metasploitte ki always_install_elevated modÃ¼lÃ¼ Ã§alÄ±ÅŸtÄ±rÄ±larak yÃ¼ksek ayrÄ±calÄ±klara geÃ§ilecek. Gerekli ayarlarÄ±n yapÄ±lÄ±p modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± ve NT AUTHORITY\SYSTEM ayrÄ±calÄ±klarÄ±na geÃ§iÅŸ aÅŸaÄŸÄ±da gÃ¶sterilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/13.png" alt="" />
</p>

<h2 id="bulma-yÃ¶ntemleri">Bulma YÃ¶ntemleri</h2>

<h3 id="yol--1-1">Yol -1:</h3>

<p>Manuel olarak komut satÄ±rÄ±nda</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg query HKLM\Software\Policies\Miscrosoft\Windows\Installer
reg query HKCU\Software\Policies\Miscrosoft\Windows\Installer
</code></pre></div></div>

<p>komutlarÄ± girildikten sonra AlwaysInstallElevated 0x1 olarak belirlenmiÅŸ olmalÄ±dÄ±r.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/10.png" alt="" />
</p>

<h3 id="yol--2-1">Yol -2:</h3>

<p><a href="https://github.com/hlldz/dazzleUP">DazzleUP</a> kullanarak yÃ¼ksek ayrÄ±calÄ±klarda yÃ¼kleme yapÄ±landÄ±rma zafiyetini tespit edebilirsiniz.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/11.png" alt="" />
</p>

<h2 id="Ã§Ã¶zÃ¼m">Ã‡Ã¶zÃ¼m</h2>

<p>KayÄ±t defteri aÃ§Ä±larak (regedit) aÅŸaÄŸÄ±da verilmiÅŸ anahtarlar iÃ§erisinden AlwaysInstallElevated deÄŸeri 0 olarak dÃ¼zenlenmelidir.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HKLM\Software\Policies\Miscrosoft\Windows\Installer
HKCU\Software\Policies\Miscrosoft\Windows\Installer
</code></pre></div></div>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/14.png" alt="" />
</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/15.png" alt="" />
</p>

<p>EÄŸer Ã¶zellik group policy ile aktif edilmiÅŸ ise policynin disable olmasÄ± gereklidir. Ä°lgili ayar iÃ§in gpedit -&gt; Computer Configuration -&gt; Administrative Templates -&gt; All Settings -&gt; Always install with elevated privileges</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/16.png" alt="" />
</p>

<p>Gerekli dÃ¼zenlemelerden sonra zafiyet tekrar araÅŸtÄ±rÄ±larak ilgili zafiyetin olmadÄ±ÄŸÄ±na dair ekran gÃ¶rÃ¼ntÃ¼sÃ¼ aÅŸaÄŸÄ±da verilmiÅŸtir.</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/17.png" alt="" />
</p>

<p align="center">
	<img src="/images/alwaysinstallelevated_ss/18.png" alt="" />
</p>

<h2 id="kaynakÃ§a">KaynakÃ§a</h2>

<ul>
  <li>https://docs.microsoft.com/en-us/windows/win32/msi/alwaysinstallelevated</li>
  <li>https://github.com/hlldz/dazzleUP</li>
  <li>https://dmcxblue.gitbook.io/red-team-notes/privesc/unquoted-service-path</li>
</ul>

:ET